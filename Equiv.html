<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>Equiv: Program Equivalence</title>
<script type="text/javascript" src="jquery-1.8.3.js"></script>
<script type="text/javascript" src="main.js"></script>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Equiv<span class="subtitle">Program Equivalence</span></h1>

<div class="code code-tight">
</div>

<div class="doc">

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Export</span> <span class="id" type="var">Imp</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab453"></a><h3 class="section">一些关于练习的一般性建议:</h3>


<div class="paragraph"> </div>

<ul class="doclist">
<li> 这里要进行的大多数Coq证明都与先前我们所提供的相似. 在做作业之前, 花一些时间
      （非形式化的在纸上和Coq中）思考我们的证明确保你理解他们的的每一个细节. 这会节省你
      大量的时间.

<div class="paragraph"> </div>


</li>
<li> 我们现在进行的Coq证明已经足够复杂，以至于近乎不可能单靠“灵感”或者以随机的尝试误打误撞的完成证明。你需要一个关于为何
      某个属性为真以及如何进行证明的概念并从这个概念开始。完成这一项任务的最好的方
      法是在开始进行形式化证明之前至少在纸上写出一个非形式化证明的梗概
<ul class="doclist">
<li>-直观的说服自己相信定理成立&mdash;然后再进行形式化证明。另外，

</li>
</ul>
      你也可以拉来一个好友，尝试说服他相信这条定理成立; 然后试着形式化你刚才的解释。

<div class="paragraph"> </div>


</li>
<li> 使用自动化工具来减少工作量！本章的一些证明练习，如果全部一个个分类去分析的话
      会非常长. 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab454"></a><h1 class="section">行为的等价性</h1>

<div class="paragraph"> </div>

 在上一章中我们讨论了一个非常简单的程序变换的正确性; <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> 函数。
    这是我们考虑的算数表达式语言的第一个版本&mdash;它没有变量&mdash;所以很容易定义 <i>什么是</i> 
    正确的程序变换： 即输出一个求值结果与原程序相同的程序。

<div class="paragraph"> </div>

    为了更进一步的讨论整个Imp语言变换的正确性，我们需要考虑状态和变量的作用。 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab455"></a><h2 class="section">定义</h2>

<div class="paragraph"> </div>

 对于包含变量的 <span class="inlinecode"><span class="id" type="var">aexp</span></span> 和 <span class="inlinecode"><span class="id" type="var">bexp</span></span>, 我们需要的定义简单明了。在 <i>所有状态</i>
    下两个 <span class="inlinecode"><span class="id" type="var">aexp</span></span> 或者 <span class="inlinecode"><span class="id" type="var">bexp</span></span> 的求值结果相同，我们就说他们 <i>行为等价</i> 。
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">aequiv</span> (<span class="id" type="var">a1</span> <span class="id" type="var">a2</span> : <span class="id" type="var">aexp</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span>:<span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">bequiv</span> (<span class="id" type="var">b1</span> <span class="id" type="var">b2</span> : <span class="id" type="var">bexp</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span>:<span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b2</span>.<br/>

<br/>
</div>

<div class="doc">
对于命令，情况有些微妙。我们不能简单的说：“如果两个指令在相同的初始状态下求值到相同
    的终止状态，那么说这两个指令等价。”，因为有些命令（在某些初始状态下）根本不会在任何
    状态终止！我们实际上需要的是：“若两个指令在给出任何初始状态时都发散或者终止在相同
    的状态上，则这两个指令行为等价。”。简单的说就是：“如果其中一个终止在某
    状态上那么另一个也终止在这个状态上，反之亦然。” 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">cequiv</span> (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>) <span style="font-family: arial;">&harr;</span> (<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab456"></a><h4 class="section">Exercise: 2 stars (equiv_classes)</h4>

<div class="paragraph"> </div>

 下面将给出一些程序，请按在<span class="inlinecode"><span class="id" type="var">Imp</span></span>中是否等价将这些程序分组。你的答案应该是一个列表的列表
    其中每个子列表代表一组互相等价的程序。例如，你认为除了程序i之外剩下的都是等价的，那么你的答案
       应该像这个样子：

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;[<span class="id" type="var">prog_a</span>;<span class="id" type="var">prog_b</span>;<span class="id" type="var">prog_c</span>;<span class="id" type="var">prog_d</span>;<span class="id" type="var">prog_e</span>;<span class="id" type="var">prog_f</span>;<span class="id" type="var">prog_g</span>;<span class="id" type="var">prog_h</span>]&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id" type="var">prog_i</span>]&nbsp;]
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

    在 <span class="inlinecode"><span class="id" type="var">equiv_classes</span></span> 的定义下面写出你的答案。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_a</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_b</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 1<br/>
&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0<br/>
&nbsp;&nbsp;<span class="id" type="var">FI</span>;;<br/>
&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>);;<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_c</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">SKIP</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_d</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AMult</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_e</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_f</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1);;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_g</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_h</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">prog_i</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">equiv_classes</span> : <span class="id" type="var">list</span> (<span class="id" type="var">list</span> <span class="id" type="var">com</span>) :=<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">admit</span>.<br/>
<span class="comment">(*&nbsp;GRADE_TEST&nbsp;2:&nbsp;check_equiv_classes&nbsp;equiv_classes&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab457"></a><h2 class="section">例子</h2>

<div class="paragraph"> </div>

 这里有些关于算数表达式和布尔表达式等价的例子. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">aequiv_example</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">aequiv</span> (<span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) (<span class="id" type="var">ANum</span> 0).<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">bequiv_example</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">bequiv</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">BTrue</span>.<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">beval</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">aequiv_example</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
这里是一些命令等价的例子，让我们从包含<span class="inlinecode"><span class="id" type="var">SKIP</span></span>的简单的程序变换开始: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">skip_left</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">c</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Seq</span> <span class="id" type="keyword">with</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Skip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab458"></a><h4 class="section">Exercise: 2 stars (skip_right)</h4>
 试证在任一命令后加上SKIP所变换出的新程序与原程序等价。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">skip_right</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c</span>;; <span class="id" type="var">SKIP</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 类似的，这里是一些简化 <span class="inlinecode"><span class="id" type="var">IFB</span></span> 的简单变换: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">IFB_true_simple</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>.<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
当然，一些程序员会尝试以IF的判断条件字面上是否等于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span> 作为优化前提。但一个
    更有趣的方式是看IF的判断条件是否等价于真:

<div class="paragraph"> </div>

   <i>Theorem</i>: 如果 <span class="inlinecode"><span class="id" type="var">b</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span>, 那么 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span>
   <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">c1</span></span>.
<a name="lab459"></a><h3 class="section"> </h3>

<div class="paragraph"> </div>

   <i>Proof</i>:

<div class="paragraph"> </div>

<ul class="doclist">
<li> (<span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span>) 我们必须证明, 对于所有 <span class="inlinecode"><span class="id" type="var">st</span></span> 和 <span class="inlinecode"><span class="id" type="var">st'</span></span>, 如果 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span>
       <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 则 <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>.

<div class="paragraph"> </div>

       能够应用于 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 的证明规则只有两条：
       <span class="inlinecode"><span class="id" type="var">E_IfTrue</span></span> 和 <span class="inlinecode"><span class="id" type="var">E_IfFalse</span></span>.

<div class="paragraph"> </div>

<ul class="doclist">
<li> 假设 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 证明自 <span class="inlinecode"><span class="id" type="var">E_IfTrue</span></span>
         这条证明规则.  若使用证明规则 <span class="inlinecode"><span class="id" type="var">E_IfTrue</span></span> 其必备的前提条件 <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 必为真， 而这正好是
         我们的证明所需要的条件。

<div class="paragraph"> </div>


</li>
<li> 另一方面, 假设 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 证明自
         <span class="inlinecode"><span class="id" type="var">E_IfFalse</span></span>. 我们能得知 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">false</span></span> 和 <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>.

<div class="paragraph"> </div>

         之前提到 <span class="inlinecode"><span class="id" type="var">b</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span>, 也就是说对于所有 <span class="inlinecode"><span class="id" type="var">st</span></span>, 有<span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">BTrue</span></span>.
         具体的说就是 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">true</span></span> 成立, 导致 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">BTrue</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">true</span></span> 成立。 
         但是与此同时，之前假设 <span class="inlinecode"><span class="id" type="var">E_IfFalse</span></span> 必备的前提条件 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">false</span></span> 也成立，
         这就构成了一组矛盾。从而说明不可能使用了 <span class="inlinecode"><span class="id" type="var">E_IfFalse</span></span> 这条证明规则。

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> (<span class="inlinecode"><span style="font-family: arial;">&larr;</span></span>) 我们必须证明，对于所有 <span class="inlinecode"><span class="id" type="var">st</span></span> 和 <span class="inlinecode"><span class="id" type="var">st'</span></span>, 如果 <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>  
       则 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>.

<div class="paragraph"> </div>

       已知 <span class="inlinecode"><span class="id" type="var">b</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span>, 我们知道 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> = <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">BTrue</span></span> = <span class="inlinecode"><span class="id" type="var">true</span></span>.
       结合 <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 这条假设, 我们能应用 <span class="inlinecode"><span class="id" type="var">E_IfTrue</span></span> 来证明出 <span class="inlinecode"><span class="id" type="var">IFB</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">THEN</span></span>
       <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">ELSE</span></span> <span class="inlinecode"><span class="id" type="var">c2</span></span> <span class="inlinecode"><span class="id" type="var">FI</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>.  <font size=-2>&#9744;</font>

</li>
</ul>

<div class="paragraph"> </div>

   下面是这个证明的形式化版本: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">IFB_true</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">BTrue</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;b&nbsp;求值得出&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;b&nbsp;求值得出&nbsp;false&nbsp;(矛盾)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hb</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hb</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab460"></a><h4 class="section">Exercise: 2 stars (IFB_false)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">IFB_false</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">BFalse</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab461"></a><h4 class="section">Exercise: 3 stars (swap_if_branches)</h4>
 证明我们可以通过对条件取反来交换 IF 的两个分支 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">swap_if_branches</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">e1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">e2</span> <span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">BNot</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">e2</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">e1</span> <span class="id" type="var">FI</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab462"></a><h3 class="section"> </h3>

<div class="paragraph"> </div>

 对于 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> 循环我们能够给出一组相似的定理：当一个循环的条件等价于 <span class="inlinecode"><span class="id" type="var">BFalse</span></span> 的
    时候它等价于 <span class="inlinecode"><span class="id" type="var">SKIP</span></span>, 当一个循环的条件等价于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span> 的时候它等价于
    <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">BTrue</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">SKIP</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> （或者任意不终止的程序）。
    前者比较简单. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">WHILE_false</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">BFalse</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>.<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">Hb</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileEnd&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Skip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileLoop&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hb</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H2</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileEnd</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab463"></a><h4 class="section">Exercise: 2 stars, advanced, optional (WHILE_false_informal)</h4>
 写出 <span class="inlinecode"><span class="id" type="var">WHILE_false</span></span> 的非形式化证明.

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
<font size=-2>&#9744;</font>

<div class="paragraph"> </div>

<a name="lab464"></a><h3 class="section"> </h3>
 为了证明第2个定理, 我们需要一个辅助定理: <span class="inlinecode"><span class="id" type="var">WHILE</span></span> 循环在条件等价于
     <span class="inlinecode"><span class="id" type="var">BTrue</span></span> 的时候循环不会终止:

<div class="paragraph"> </div>

    <i>Lemma</i>: 如果 <span class="inlinecode"><span class="id" type="var">b</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span>, 则不可能像
     <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 这样会终止。

<div class="paragraph"> </div>

    <i>Proof</i>: 假设循环会终止，即 <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>.  我们将证明在通过
    对 <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 使用归纳法可以引出矛盾。

<div class="paragraph"> </div>

<ul class="doclist">
<li> 假设 <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 使用了 <span class="inlinecode"><span class="id" type="var">E_WhileEnd</span></span> 这条证明规则。
        那么根据假设得出 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">false</span></span> 。但是这和 <span class="inlinecode"><span class="id" type="var">b</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">BTrue</span></span> 矛盾。

<div class="paragraph"> </div>


</li>
<li> 假设 <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 使用了 <span class="inlinecode"><span class="id" type="var">E_WhileLoop</span></span> 这条证明规则.
        结果就是给出了一个和 <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 矛盾的假设, 正巧是
        我们正要证明的那个!

<div class="paragraph"> </div>


</li>
<li> 由于只有以上的几条规则可以证明出 <span class="inlinecode">(<span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode"><span class="id" type="var">END</span>)</span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 所以归纳时
        的其他的情况会立即导致矛盾。 <font size=-2>&#9744;</font> 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">WHILE_true_nonterm</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">BTrue</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~( (<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> ).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">cw</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqcw</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;大多数证明规则不可能应用，我们可以用&nbsp;反演（inversion）来去除他们&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqcw</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Heqcw</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;我们只关心这两个关于&nbsp;WHILE&nbsp;循环的证明规则:&nbsp;*)</span><br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;E_WhileEnd&nbsp;*)</span> <span class="comment">(*&nbsp;矛盾&nbsp;--&nbsp;b&nbsp;总是&nbsp;true!&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span> <span class="id" type="keyword">in</span> <span class="id" type="var">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;<span class="inlinecode"><span class="id" type="tactic">rewrite</span></span>&nbsp;能实例化Hb中的变量&nbsp;<span class="inlinecode"><span class="id" type="var">st</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hb</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;E_WhileLoop&nbsp;*)</span> <span class="comment">(*&nbsp;直接使用IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHceval2</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab465"></a><h4 class="section">Exercise: 2 stars, optional (WHILE_true_nonterm_informal)</h4>
 试解释 <span class="inlinecode"><span class="id" type="var">WHILE_true_nonterm</span></span> 的意义。

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
 <font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab466"></a><h4 class="section">Exercise: 2 stars (WHILE_true)</h4>
 证明下面的定理. <i>提示</i> : 你可能需要使用 <span class="inlinecode"><span class="id" type="var">WHILE_true_nonterm</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">WHILE_true</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">BTrue</span>  <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">loop_unrolling</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> (<span class="id" type="var">c</span>;; <span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span>) <span class="id" type="var">ELSE</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">FI</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hce</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;不执行循环&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Skip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;执行循环&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Seq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st'</span> := <span class="id" type="var">st'0</span>). <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hce</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;执行循环&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileLoop</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st'</span> := <span class="id" type="var">st'0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;不执行循环&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H5</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileEnd</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab467"></a><h4 class="section">Exercise: 2 stars, optional (seq_assoc)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">seq_assoc</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">c3</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> ((<span class="id" type="var">c1</span>;;<span class="id" type="var">c2</span>);;<span class="id" type="var">c3</span>) (<span class="id" type="var">c1</span>;;(<span class="id" type="var">c2</span>;;<span class="id" type="var">c3</span>)).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab468"></a><h2 class="section">外延公理</h2>

<div class="paragraph"> </div>

 最后, 我们来看看含有赋值的简单等价.
    比如, 我们也许会希望能够证明 <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">AId</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span> 和 <span class="inlinecode"><span class="id" type="var">SKIP</span></span> 等价。但是，
    我们当试着证明它的时候, 我们会以一种很奇妙的方式卡住。
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">identity_assignment_first_try</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">X</span>:<span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">AId</span> <span class="id" type="var">X</span>) <span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>)) <span class="id" type="keyword">with</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;卡住了...&nbsp;*)</span> <span class="id" type="keyword">Abort</span>.<br/>

<br/>
</div>

<div class="doc">
现在我们卡住了. 虽然结论看起来很合理，但是实际上它是无法证明的!  如果我们回顾在上一章
    我们曾证明的有关 <span class="inlinecode"><span class="id" type="var">update</span></span> 的引理, 我们能够看到引理 <span class="inlinecode"><span class="id" type="var">update_same</span></span> 几乎能够完
      成它的工作，但是它完成得不彻底：它声称所有的变量在原状态和新状态下的值都
      相同，但是从Coq的角度来看，这与声称原状态 <span class="inlinecode">=</span> 新状态并不相同！ 
<div class="paragraph"> </div>

 这里发生了什么?  回顾我们定义的 state ，它只是一个将 id 映射到 值 的函数。在Coq中
    函数（化简后）的定义在语法上相同时它们才相同。
    (这是能使用归纳命题 <span class="inlinecode"><span class="id" type="var">eq</span></span> 中构造子 <span class="inlinecode"><span class="id" type="var">refl_equal</span></span> 的唯一方法!)
    实际上，对于重复使用 <span class="inlinecode"><span class="id" type="var">update</span></span> 构建起来的函数, 只有两个函数使用
    <i>相同的</i> <span class="inlinecode"><span class="id" type="var">update</span></span> 构建过程才能证明他们是相同的。
    在上面的定理中, 在 <span class="inlinecode"><span class="id" type="var">cequiv</span></span> 中第一个的 update 链比第二个的长，因此它们毫无疑问是不相等
    的。 
<div class="paragraph"> </div>

<a name="lab469"></a><h3 class="section"> </h3>
 这种问题其实挺常见. 比如我们尝试证明比如这样的定理

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span>&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;1)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>&nbsp;+&nbsp;2)
<div class="paragraph"> </div>

</div>
    或者这样的定理

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span>&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;1;;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;2)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">y</span>&nbsp;::=&nbsp;2;;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;1)<br/>
&nbsp;&nbsp;
<div class="paragraph"> </div>

</div>
    我们会以相同的方式卡住: 会有两个对所有输入都有相同行为的函数, 但是我们无法证明它们互相 <span class="inlinecode"><span class="id" type="var">eq</span></span> 。

<div class="paragraph"> </div>

    对于这类情况我们使用被人们称为 <i>外延公理</i> ( <i>functional extensionality</i> ）
    的推理原则::
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule"><span style="font-family: arial;">&forall;</span>x,&nbsp;f&nbsp;x&nbsp;=&nbsp;g&nbsp;x</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">f&nbsp;=&nbsp;g</td>
  <td></td>
</td>
</table></center>    这条原则虽然在Coq内建逻辑中没办法推导, 但是把这条原则当作 <i>公理</i> （ <i>axiom</i> ）
    加入到Coq中是安全的。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Axiom</span> <span class="id" type="var">functional_extensionality</span> : <span style="font-family: arial;">&forall;</span>{<span class="id" type="var">X</span> <span class="id" type="var">Y</span>: <span class="id" type="keyword">Type</span>} {<span class="id" type="var">f</span> <span class="id" type="var">g</span> : <span class="id" type="var">X</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Y</span>},<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">x</span>: <span class="id" type="var">X</span>), <span class="id" type="var">f</span> <span class="id" type="var">x</span> = <span class="id" type="var">g</span> <span class="id" type="var">x</span>) <span style="font-family: arial;">&rarr;</span>  <span class="id" type="var">f</span> = <span class="id" type="var">g</span>.<br/>

<br/>
</div>

<div class="doc">
我们可以证明增加这条公理不会破坏Coq的一致性。（从这个角度看, 这与在Coq中添加
    古典逻辑中的其中一条诸如排中律公理（<span class="inlinecode"><span class="id" type="var">excluded_middle</span></span>）类似。） 
<div class="paragraph"> </div>

 多亏了这条公理我们可以证明我们的定理了.  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">identity_assignment</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">X</span>:<span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">AId</span> <span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> (<span class="id" type="var">st</span> <span class="id" type="var">X</span>)) <span class="id" type="keyword">with</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_same</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">st'</span> = (<span class="id" type="var">update</span> <span class="id" type="var">st'</span> <span class="id" type="var">X</span> (<span class="id" type="var">st'</span> <span class="id" type="var">X</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">functional_extensionality</span>. <span class="id" type="tactic">intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">update_same</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">H0</span> <span class="id" type="tactic">at</span> 2.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab470"></a><h4 class="section">Exercise: 2 stars (assign_aequiv)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">assign_aequiv</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">X</span> <span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">aequiv</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) <span class="id" type="var">e</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">SKIP</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">e</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab471"></a><h1 class="section">行为等价的性质</h1>

<div class="paragraph"> </div>

 现在我们开始开发之前定义的程序等价中的一些性质. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab472"></a><h2 class="section">行为等价是一种等价性</h2>

<div class="paragraph"> </div>

 首先, 我们验证 <span class="inlinecode"><span class="id" type="var">aexps</span></span>, <span class="inlinecode"><span class="id" type="var">bexps</span></span>, 和 <span class="inlinecode"><span class="id" type="var">com</span></span> 的确满足 <i>等价性</i> （ <i>equivalences</i> ）
 也就是说, 它们都满足 自反性（reflexive），对称性（symmetric）和 传递性（transitive）。
    这些证明全都不难。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">refl_aequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">a</span> : <span class="id" type="var">aexp</span>), <span class="id" type="var">aequiv</span> <span class="id" type="var">a</span> <span class="id" type="var">a</span>.<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">a</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">sym_aequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">a1</span> <span class="id" type="var">a2</span> : <span class="id" type="var">aexp</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">aequiv</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aequiv</span> <span class="id" type="var">a2</span> <span class="id" type="var">a1</span>.<br/>
<div class="togglescript" id="proofcontrol7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')"><span class="show"></span></div>
<div class="proofscript" id="proof7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">trans_aequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">a3</span> : <span class="id" type="var">aexp</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">aequiv</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aequiv</span> <span class="id" type="var">a2</span> <span class="id" type="var">a3</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aequiv</span> <span class="id" type="var">a1</span> <span class="id" type="var">a3</span>.<br/>
<div class="togglescript" id="proofcontrol8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')"><span class="show"></span></div>
<div class="proofscript" id="proof8" onclick="toggleDisplay('proof8');toggleDisplay('proofcontrol8')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">aequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">a3</span> <span class="id" type="var">H12</span> <span class="id" type="var">H23</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H12</span> <span class="id" type="var">st</span>). <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H23</span> <span class="id" type="var">st</span>). <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">refl_bequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b</span> : <span class="id" type="var">bexp</span>), <span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">b</span>.<br/>
<div class="togglescript" id="proofcontrol9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')"><span class="show"></span></div>
<div class="proofscript" id="proof9" onclick="toggleDisplay('proof9');toggleDisplay('proofcontrol9')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">b</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">sym_bequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b1</span> <span class="id" type="var">b2</span> : <span class="id" type="var">bexp</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bequiv</span> <span class="id" type="var">b2</span> <span class="id" type="var">b1</span>.<br/>
<div class="togglescript" id="proofcontrol10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')"><span class="show"></span></div>
<div class="proofscript" id="proof10" onclick="toggleDisplay('proof10');toggleDisplay('proofcontrol10')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>. <span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">trans_bequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b1</span> <span class="id" type="var">b2</span> <span class="id" type="var">b3</span> : <span class="id" type="var">bexp</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bequiv</span> <span class="id" type="var">b2</span> <span class="id" type="var">b3</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bequiv</span> <span class="id" type="var">b1</span> <span class="id" type="var">b3</span>.<br/>
<div class="togglescript" id="proofcontrol11" onclick="toggleDisplay('proof11');toggleDisplay('proofcontrol11')"><span class="show"></span></div>
<div class="proofscript" id="proof11" onclick="toggleDisplay('proof11');toggleDisplay('proofcontrol11')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span> <span class="id" type="var">b3</span> <span class="id" type="var">H12</span> <span class="id" type="var">H23</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H12</span> <span class="id" type="var">st</span>). <span class="id" type="tactic">rewrite</span> (<span class="id" type="var">H23</span> <span class="id" type="var">st</span>). <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">refl_cequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c</span> : <span class="id" type="var">com</span>), <span class="id" type="var">cequiv</span> <span class="id" type="var">c</span> <span class="id" type="var">c</span>.<br/>
<div class="togglescript" id="proofcontrol12" onclick="toggleDisplay('proof12');toggleDisplay('proofcontrol12')"><span class="show"></span></div>
<div class="proofscript" id="proof12" onclick="toggleDisplay('proof12');toggleDisplay('proofcontrol12')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">cequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">iff_refl</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">sym_cequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c2</span> <span class="id" type="var">c1</span>.<br/>
<div class="togglescript" id="proofcontrol13" onclick="toggleDisplay('proof13');toggleDisplay('proofcontrol13')"><span class="show"></span></div>
<div class="proofscript" id="proof13" onclick="toggleDisplay('proof13');toggleDisplay('proofcontrol13')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">cequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">H</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&harr;</span> <span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">H'</span>.<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;断言的证明&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. }<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">iff_sym</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">iff_trans</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P1</span> <span class="id" type="var">P2</span> <span class="id" type="var">P3</span> : <span class="id" type="keyword">Prop</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="var">P1</span> <span style="font-family: arial;">&harr;</span> <span class="id" type="var">P2</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">P2</span> <span style="font-family: arial;">&harr;</span> <span class="id" type="var">P3</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">P1</span> <span style="font-family: arial;">&harr;</span> <span class="id" type="var">P3</span>).<br/>
<div class="togglescript" id="proofcontrol14" onclick="toggleDisplay('proof14');toggleDisplay('proofcontrol14')"><span class="show"></span></div>
<div class="proofscript" id="proof14" onclick="toggleDisplay('proof14');toggleDisplay('proofcontrol14')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P1</span> <span class="id" type="var">P2</span> <span class="id" type="var">P3</span> <span class="id" type="var">H12</span> <span class="id" type="var">H23</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H12</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H23</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">A</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H1</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">A</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H0</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H2</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">A</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">trans_cequiv</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">c3</span> : <span class="id" type="var">com</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c2</span> <span class="id" type="var">c3</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c3</span>.<br/>
<div class="togglescript" id="proofcontrol15" onclick="toggleDisplay('proof15');toggleDisplay('proofcontrol15')"><span class="show"></span></div>
<div class="proofscript" id="proof15" onclick="toggleDisplay('proof15');toggleDisplay('proofcontrol15')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">cequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">c3</span> <span class="id" type="var">H12</span> <span class="id" type="var">H23</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">iff_trans</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">H12</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H23</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab473"></a><h2 class="section">行为等价是一种一致性</h2>

<div class="paragraph"> </div>

 不太明显地, 行为等价也满足 <i>一致性</i> （ <i>congruence</i> ). 也就是说
    两个子程序等价那么只有子程序有差异的两个大程序也等价:
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">aequiv&nbsp;a1&nbsp;a1'</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">cequiv&nbsp;(i&nbsp;::=&nbsp;a1)&nbsp;(i&nbsp;::=&nbsp;a1')</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">cequiv&nbsp;c1&nbsp;c1'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">cequiv&nbsp;c2&nbsp;c2'</td>
  <td class="infrulenamecol" rowspan="3">
    &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">cequiv&nbsp;(c1;;c2)&nbsp;(c1';;c2')</td>
  <td></td>
</td>
</table></center>    ...等等.  

<div class="paragraph"> </div>

    (注意我们这里用的推理规则记号并不是定义的一部分, 只是将一些合法的蕴含式用易读的方式写下而已.
    接下来我们将证明这些蕴含式.) 
<div class="paragraph"> </div>

 我们会在接下来的章节（在 <span class="inlinecode"><span class="id" type="var">fold_constants_com_sound</span></span> 的证明中）看到
    一些例子能够说明为何这些一致性十分重要。但是它的主要意义在于这些一致性允许我们在用一小部
    分程序替换一个大程序中等价的一部分并证明替换前和替换后程序的等价
    性时 <i>无需</i> 进行与不变的部分相关的证明；也即是说，程序的改变所产生
    的证明的工作量与改变的大小而不是与整个程序的大小成比例。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">CAss_congruence</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">i</span> <span class="id" type="var">a1</span> <span class="id" type="var">a1'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">aequiv</span> <span class="id" type="var">a1</span> <span class="id" type="var">a1'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> (<span class="id" type="var">CAss</span> <span class="id" type="var">i</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">CAss</span> <span class="id" type="var">i</span> <span class="id" type="var">a1'</span>).<br/>
<div class="togglescript" id="proofcontrol16" onclick="toggleDisplay('proof16');toggleDisplay('proofcontrol16')"><span class="show"></span></div>
<div class="proofscript" id="proof16" onclick="toggleDisplay('proof16');toggleDisplay('proofcontrol16')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">i</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> <span class="id" type="var">Heqv</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">Hceval</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqv</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">Hceval</span>. <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Heqv</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
循环的一致性更有趣, 因为他需要使用归纳法（induction）.

<div class="paragraph"> </div>

    <i>Theorem</i>: 对于 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> ，等价性是一种一致性 &mdash; 也就是说, 如果 <span class="inlinecode"><span class="id" type="var">b1</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">b1'</span></span>
    同时 <span class="inlinecode"><span class="id" type="var">c1</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">c1'</span></span> ，那么 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> 等价于
     <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> 。

<div class="paragraph"> </div>

    <i>Proof</i>: 假设 <span class="inlinecode"><span class="id" type="var">b1</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">b1'</span></span> 同时 <span class="inlinecode"><span class="id" type="var">c1</span></span> 等价于 <span class="inlinecode"><span class="id" type="var">c1'</span></span> 。
    我们要证明，对于所有 <span class="inlinecode"><span class="id" type="var">st</span></span> 和 <span class="inlinecode"><span class="id" type="var">st'</span></span> ， <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>
    当且仅当 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 。我们把两个方向分开考虑。

<div class="paragraph"> </div>

<ul class="doclist">
<li> (<span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span>) 我们证明 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 蕴涵
        <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> ，对 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>
        使用归纳法。只有推导最后所使用的规则是 <span class="inlinecode"><span class="id" type="var">E_WhileEnd</span></span> 和 <span class="inlinecode"><span class="id" type="var">E_WhileLoop</span></span> 情况才需要
	   特别进行讨论。

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">E_WhileEnd</span></span>: 在这种情况时, 我们拥有假设的必备条件 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">false</span></span>
            和 <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 。但是，因为 <span class="inlinecode"><span class="id" type="var">b1</span></span> 和 <span class="inlinecode"><span class="id" type="var">b1'</span></span> 是等价的，
            我们有 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">false</span></span>, 然后应用 <span class="inlinecode"><span class="id" type="var">E</span>-<span class="id" type="var">WhileEnd</span></span> ，
            得出我们需要的 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 。

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="var">E_WhileLoop</span></span>: 在这种情况时, 我们拥有假设的必备条件 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">true</span></span> ， 
            <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'0</span></span> 和 以及对某个状态 <span class="inlinecode"><span class="id" type="var">st'0</span></span> 而言，有假设 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st'0</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span>
            ，另外还有归纳假设 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st'0</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 。

<div class="paragraph"> </div>

            因为 <span class="inlinecode"><span class="id" type="var">c1</span></span> 和 <span class="inlinecode"><span class="id" type="var">c1'</span></span> 等价，推导出 <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'0</span></span> 。
            然后因为 <span class="inlinecode"><span class="id" type="var">b1</span></span> 和 <span class="inlinecode"><span class="id" type="var">b1'</span></span> 等价，推导出 <span class="inlinecode"><span class="id" type="var">beval</span></span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">true</span></span> ，
            最后应用 <span class="inlinecode"><span class="id" type="var">E</span>-<span class="id" type="var">WhileLoop</span></span> ，得出我们
            需要的 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> <span class="inlinecode"><span class="id" type="var">b1'</span></span> <span class="inlinecode"><span class="id" type="var">DO</span></span> <span class="inlinecode"><span class="id" type="var">c1'</span></span> <span class="inlinecode"><span class="id" type="var">END</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> 。

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> (<span class="inlinecode"><span style="font-family: arial;">&larr;</span></span>) 反之亦然. <font size=-2>&#9744;</font> 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">CWhile_congruence</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b1</span> <span class="id" type="var">b1'</span> <span class="id" type="var">c1</span> <span class="id" type="var">c1'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b1</span> <span class="id" type="var">b1'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c1'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1'</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1'</span> <span class="id" type="var">END</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;WORKED&nbsp;IN&nbsp;CLASS&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span>,<span class="id" type="var">cequiv</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">b1</span> <span class="id" type="var">b1'</span> <span class="id" type="var">c1</span> <span class="id" type="var">c1'</span> <span class="id" type="var">Hb1e</span> <span class="id" type="var">Hc1e</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">Hce</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">cwhile</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqcwhile</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hce</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqcwhile</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileEnd&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileEnd</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Hb1e</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileLoop&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileLoop</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st'</span> := <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="comment">(*&nbsp;show&nbsp;loop&nbsp;runs&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">Hb1e</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="comment">(*&nbsp;body&nbsp;execution&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hc1e</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">Hce1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="comment">(*&nbsp;subsequent&nbsp;loop&nbsp;execution&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHHce2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1'</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1'</span> <span class="id" type="var">END</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">c'while</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqc'while</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">Hce</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Heqc'while</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileEnd&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileEnd</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Hb1e</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;E_WhileLoop&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileLoop</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st'</span> := <span class="id" type="var">st'</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="comment">(*&nbsp;show&nbsp;loop&nbsp;runs&nbsp;*)</span> <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">Hb1e</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="comment">(*&nbsp;body&nbsp;execution&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">Hc1e</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">Hce1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="comment">(*&nbsp;subsequent&nbsp;loop&nbsp;execution&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHHce2</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab474"></a><h4 class="section">Exercise: 3 stars, optional (CSeq_congruence)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">CSeq_congruence</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">c1</span> <span class="id" type="var">c1'</span> <span class="id" type="var">c2</span> <span class="id" type="var">c2'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c1'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c2</span> <span class="id" type="var">c2'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> (<span class="id" type="var">c1</span>;;<span class="id" type="var">c2</span>) (<span class="id" type="var">c1'</span>;;<span class="id" type="var">c2'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab475"></a><h4 class="section">Exercise: 3 stars (CIf_congruence)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">CIf_congruence</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b</span> <span class="id" type="var">b'</span> <span class="id" type="var">c1</span> <span class="id" type="var">c1'</span> <span class="id" type="var">c2</span> <span class="id" type="var">c2'</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> <span class="id" type="var">b'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c1'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv</span> <span class="id" type="var">c2</span> <span class="id" type="var">c2'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) (<span class="id" type="var">IFB</span> <span class="id" type="var">b'</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1'</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2'</span> <span class="id" type="var">FI</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab476"></a><h3 class="section"> </h3>

<div class="paragraph"> </div>

 比如, 这里有两个等价的程序, 和他们的等价性证明... 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">congruence_example</span>:<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Program&nbsp;1:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> 0;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 42<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Program&nbsp;2:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> 0;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)   <span class="comment">(*&nbsp;&lt;---&nbsp;这里有改动&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 42<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">CSeq_congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_cequiv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">CIf_congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_bequiv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">CAss_congruence</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">aequiv</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">minus_diag</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">refl_cequiv</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab477"></a><h1 class="section">程序变换</h1>

<div class="paragraph"> </div>

 <i>程序变换</i> （ <i>program transformation</i> ）是一种以任意程序
    作为输入并且输出这个程序的某种变体的函数。比如编译中的常量折叠优化就是
    一个典型的例子，但是程序变换不限于此。 
<div class="paragraph"> </div>

 如果一个程序变换的输出持有与其输入程序相同的行为，那么这个程序变换
    是 <i>健全</i> （ <i>sound</i> ）的. 

<div class="paragraph"> </div>

    我们可以定义出 <span class="inlinecode"><span class="id" type="var">aexp</span></span>, <span class="inlinecode"><span class="id" type="var">bexp</span></span>, 和 <span class="inlinecode"><span class="id" type="var">com</span></span> 的健全性的概念。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">atrans_sound</span> (<span class="id" type="var">atrans</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">a</span> : <span class="id" type="var">aexp</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aequiv</span> <span class="id" type="var">a</span> (<span class="id" type="var">atrans</span> <span class="id" type="var">a</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">btrans_sound</span> (<span class="id" type="var">btrans</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b</span> : <span class="id" type="var">bexp</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> (<span class="id" type="var">btrans</span> <span class="id" type="var">b</span>).<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ctrans_sound</span> (<span class="id" type="var">ctrans</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">c</span> (<span class="id" type="var">ctrans</span> <span class="id" type="var">c</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab478"></a><h2 class="section">常量折叠变换</h2>

<div class="paragraph"> </div>

 如果一个表达式不引用变量, 那么他就是 <i>常量</i> （ <i>constant</i> ）.

<div class="paragraph"> </div>

    常量折叠是这样一种优化方式：找到常量表达式然后用它们的值替换它们. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">fold_constants_aexp</span> (<span class="id" type="var">a</span> : <span class="id" type="var">aexp</span>) : <span class="id" type="var">aexp</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">a</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span>       ⇒ <span class="id" type="var">ANum</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AId</span> <span class="id" type="var">i</span>        ⇒ <span class="id" type="var">AId</span> <span class="id" type="var">i</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>, <span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n1</span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n2</span>) ⇒ <span class="id" type="var">ANum</span> (<span class="id" type="var">n1</span> + <span class="id" type="var">n2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a1'</span>, <span class="id" type="var">a2'</span>) ⇒ <span class="id" type="var">APlus</span> <span class="id" type="var">a1'</span> <span class="id" type="var">a2'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>, <span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n1</span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n2</span>) ⇒ <span class="id" type="var">ANum</span> (<span class="id" type="var">n1</span> - <span class="id" type="var">n2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a1'</span>, <span class="id" type="var">a2'</span>) ⇒ <span class="id" type="var">AMinus</span> <span class="id" type="var">a1'</span> <span class="id" type="var">a2'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>, <span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n1</span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n2</span>) ⇒ <span class="id" type="var">ANum</span> (<span class="id" type="var">n1</span> × <span class="id" type="var">n2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a1'</span>, <span class="id" type="var">a2'</span>) ⇒ <span class="id" type="var">AMult</span> <span class="id" type="var">a1'</span> <span class="id" type="var">a2'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">fold_aexp_ex1</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fold_constants_aexp</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">AMult</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">ANum</span> 2)) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) <br/>
&nbsp;&nbsp;= <span class="id" type="var">AMult</span> (<span class="id" type="var">ANum</span> 3) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
注意这个版本的常量折叠不包括优化显而易见的加法等. &mdash; 为了简单起见我们先
    把注意力集中在一个优化上.  把其他简化表达式的优化合并进来也不难; 只是
    定义和证明会更长. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">fold_aexp_ex2</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fold_constants_aexp</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">APlus</span> (<span class="id" type="var">AMult</span> (<span class="id" type="var">ANum</span> 0) (<span class="id" type="var">ANum</span> 6)) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)))<br/>
&nbsp;&nbsp;= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 0) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab479"></a><h3 class="section"> </h3>
 我们不仅可以把 <span class="inlinecode"><span class="id" type="var">fold_constants_aexp</span></span> 优化到 <span class="inlinecode"><span class="id" type="var">bexp</span></span> (比如在某些 <span class="inlinecode"><span class="id" type="var">BEq</span></span>
    和 <span class="inlinecode"><span class="id" type="var">BLe</span></span> 的时候), 我们也能找到一些 <i>布尔</i> （ <i>boolean</i> ）表达式的常量
    在原地化简他们. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">fold_constants_bexp</span> (<span class="id" type="var">b</span> : <span class="id" type="var">bexp</span>) : <span class="id" type="var">bexp</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BTrue</span>        ⇒ <span class="id" type="var">BTrue</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BFalse</span>       ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BEq</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>, <span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n1</span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n2</span>) ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">beq_nat</span> <span class="id" type="var">n1</span> <span class="id" type="var">n2</span> <span class="id" type="keyword">then</span> <span class="id" type="var">BTrue</span> <span class="id" type="keyword">else</span> <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a1'</span>, <span class="id" type="var">a2'</span>) ⇒ <span class="id" type="var">BEq</span> <span class="id" type="var">a1'</span> <span class="id" type="var">a2'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BLe</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>, <span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">ANum</span> <span class="id" type="var">n1</span>, <span class="id" type="var">ANum</span> <span class="id" type="var">n2</span>) ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">ble_nat</span> <span class="id" type="var">n1</span> <span class="id" type="var">n2</span> <span class="id" type="keyword">then</span> <span class="id" type="var">BTrue</span> <span class="id" type="keyword">else</span> <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">a1'</span>, <span class="id" type="var">a2'</span>) ⇒ <span class="id" type="var">BLe</span> <span class="id" type="var">a1'</span> <span class="id" type="var">a2'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BNot</span> <span class="id" type="var">b1</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b1</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BTrue</span> ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> ⇒ <span class="id" type="var">BTrue</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">b1'</span> ⇒ <span class="id" type="var">BNot</span> <span class="id" type="var">b1'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BAnd</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b1</span>, <span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BTrue</span>, <span class="id" type="var">BTrue</span>) ⇒ <span class="id" type="var">BTrue</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BTrue</span>, <span class="id" type="var">BFalse</span>) ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BFalse</span>, <span class="id" type="var">BTrue</span>) ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">BFalse</span>, <span class="id" type="var">BFalse</span>) ⇒ <span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">b1'</span>, <span class="id" type="var">b2'</span>) ⇒ <span class="id" type="var">BAnd</span> <span class="id" type="var">b1'</span> <span class="id" type="var">b2'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">fold_bexp_ex1</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fold_constants_bexp</span> (<span class="id" type="var">BAnd</span> <span class="id" type="var">BTrue</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BAnd</span> <span class="id" type="var">BFalse</span> <span class="id" type="var">BTrue</span>)))<br/>
&nbsp;&nbsp;= <span class="id" type="var">BTrue</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">fold_bexp_ex2</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fold_constants_bexp</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">BAnd</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">BEq</span> (<span class="id" type="var">ANum</span> 0) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">AMinus</span> (<span class="id" type="var">ANum</span> 2) (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 1) (<span class="id" type="var">ANum</span> 1)))))<br/>
&nbsp;&nbsp;= <span class="id" type="var">BAnd</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) <span class="id" type="var">BTrue</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab480"></a><h3 class="section"> </h3>
 为了化简程序中的常量, 我们需要在所有子表达式上使用适当的函数. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">fold_constants_com</span> (<span class="id" type="var">c</span> : <span class="id" type="var">com</span>) : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">SKIP</span>      ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">i</span> ::= <span class="id" type="var">a</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">CAss</span> <span class="id" type="var">i</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">c1</span> ;; <span class="id" type="var">c2</span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c1</span>) ;; (<span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BTrue</span> ⇒ <span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> ⇒ <span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">b'</span> ⇒ <span class="id" type="var">IFB</span> <span class="id" type="var">b'</span> <span class="id" type="var">THEN</span> <span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c1</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span> <span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BTrue</span> ⇒ <span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> ⇒ <span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">b'</span> ⇒ <span class="id" type="var">WHILE</span> <span class="id" type="var">b'</span> <span class="id" type="var">DO</span> (<span class="id" type="var">fold_constants_com</span> <span class="id" type="var">c</span>) <span class="id" type="var">END</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab481"></a><h3 class="section"> </h3>

</div>
<div class="code code-space">
<span class="id" type="keyword">Example</span> <span class="id" type="var">fold_com_ex1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">fold_constants_com</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;原程序:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 4) (<span class="id" type="var">ANum</span> 5);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 3);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">BEq</span> (<span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 2) (<span class="id" type="var">ANum</span> 4)) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">BLe</span> (<span class="id" type="var">ANum</span> 0) (<span class="id" type="var">AMinus</span> (<span class="id" type="var">ANum</span> 4) (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 2) (<span class="id" type="var">ANum</span> 1))) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 0) <span class="id" type="var">DO</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>) <br/>
&nbsp;&nbsp;= <span class="comment">(*&nbsp;常量折叠后:&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> 9;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 3);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">IFB</span> <span class="id" type="var">BEq</span> (<span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)) (<span class="id" type="var">ANum</span> 6) <span class="id" type="var">THEN</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ELSE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">FI</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 0;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span> 0) <span class="id" type="var">DO</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab482"></a><h2 class="section">常量折叠的健全性</h2>

<div class="paragraph"> </div>

 现在我们证明之前所做的事情的正确性. 
<div class="paragraph"> </div>

 这是对算数表达式的证明: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">fold_constants_aexp_sound</span> : <br/>
&nbsp;&nbsp;<span class="id" type="var">atrans_sound</span> <span class="id" type="var">fold_constants_aexp</span>.<br/>
<div class="togglescript" id="proofcontrol17" onclick="toggleDisplay('proof17');toggleDisplay('proofcontrol17')"><span class="show"></span></div>
<div class="proofscript" id="proof17" onclick="toggleDisplay('proof17');toggleDisplay('proofcontrol17')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">atrans_sound</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">a</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">aequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>; <span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;ANum&nbsp;和&nbsp;AId&nbsp;很显然&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;从IH和下面的观察出发很容易完成&nbsp;APlus&nbsp;,&nbsp;Aminus&nbsp;和&nbsp;AMult&nbsp;的情况的证明：<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aeval&nbsp;st&nbsp;(APlus&nbsp;a1&nbsp;a2)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ANum&nbsp;((aeval&nbsp;st&nbsp;a1)&nbsp;+&nbsp;(aeval&nbsp;st&nbsp;a2))&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;aeval&nbsp;st&nbsp;(ANum&nbsp;((aeval&nbsp;st&nbsp;a1)&nbsp;+&nbsp;(aeval&nbsp;st&nbsp;a2)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(之后的s&nbsp;AMinus/minus&nbsp;和&nbsp;AMult/mult&nbsp;同理)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">destruct</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHa2</span>; <span class="id" type="tactic">reflexivity</span>). <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab483"></a><h4 class="section">Exercise: 3 stars, optional (fold_bexp_Eq_informal)</h4>
 这里有一个 “布尔表达式常量折叠中 <span class="inlinecode"><span class="id" type="var">BEq</span></span> 的健全性” 的非形式化证明。认真读完
    再和下面的形式化证明做比较。然后补充完整下面 <span class="inlinecode"><span class="id" type="var">BLe</span></span> 的情况的形式化证明 （尽量
    不看之前的 <span class="inlinecode"><span class="id" type="var">BEq</span></span> 的情况的证明 ）。

<div class="paragraph"> </div>

   <i>Theorem</i>: 布尔表达式的常量折叠函数 <span class="inlinecode"><span class="id" type="var">fold_constants_bexp</span></span> ，有健全性。

<div class="paragraph"> </div>

   <i>Proof</i>: 我们必须证明 对于所有 <span class="inlinecode"><span class="id" type="var">b</span></span> ， <span class="inlinecode"><span class="id" type="var">fold_constants_bexp</span></span> 有健全性。
   我们在 <span class="inlinecode"><span class="id" type="var">b</span></span> 上使用归纳法. 这里只给出 <span class="inlinecode"><span class="id" type="var">b</span></span> 有 <span class="inlinecode"><span class="id" type="var">BEq</span></span> <span class="inlinecode"><span class="id" type="var">a1</span></span> <span class="inlinecode"><span class="id" type="var">a2</span></span> 的形式的证明。

<div class="paragraph"> </div>

   在本例中, 我们需要证明 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_bexp</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)).
<div class="paragraph"> </div>

</div>
   有两种情况需要讨论：

<div class="paragraph"> </div>

<ul class="doclist">
<li> 首先，假设对于某些 <span class="inlinecode"><span class="id" type="var">n1</span></span> 和 <span class="inlinecode"><span class="id" type="var">n2</span></span> 而言有 <span class="inlinecode"><span class="id" type="var">fold_constants_aexp</span></span> <span class="inlinecode"><span class="id" type="var">a1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode"><span class="id" type="var">n1</span></span> 和
       <span class="inlinecode"><span class="id" type="var">fold_constants_aexp</span></span> <span class="inlinecode"><span class="id" type="var">a2</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode"><span class="id" type="var">n2</span></span> 成立。

<div class="paragraph"> </div>

       在这种情况下，我们有

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">fold_constants_bexp</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">BTrue</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">BFalse</span>
<div class="paragraph"> </div>

</div>
       和

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a1</span>)&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a2</span>).
<div class="paragraph"> </div>

</div>
       由于算数表达式的健全性(定理 <span class="inlinecode"><span class="id" type="var">fold_constants_aexp_sound</span></span>)，可得

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a1</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">ANum</span>&nbsp;<span class="id" type="var">n1</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">n1</span>
<div class="paragraph"> </div>

</div>
       和

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a2</span>&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">ANum</span>&nbsp;<span class="id" type="var">n2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">n2</span>,
<div class="paragraph"> </div>

</div>
       所以

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">a1</span>)&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>.
<div class="paragraph"> </div>

</div>
       同时, 容易看出 （在分别考虑 <span class="inlinecode"><span class="id" type="var">n1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">n2</span></span> 和 <span class="inlinecode"><span class="id" type="var">n1</span></span> <span class="inlinecode">≠</span> <span class="inlinecode"><span class="id" type="var">n2</span></span> 的情况之后）

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">BTrue</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">BFalse</span>)<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">BTrue</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">BFalse</span><br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">true</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">false</span><br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>.
<div class="paragraph"> </div>

</div>
       所以

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>.<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="keyword">if</span>&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;<span class="id" type="var">n1</span>&nbsp;<span class="id" type="var">n2</span>&nbsp;<span class="id" type="keyword">then</span>&nbsp;<span class="id" type="var">BTrue</span>&nbsp;<span class="id" type="keyword">else</span>&nbsp;<span class="id" type="var">BFalse</span>),
<div class="paragraph"> </div>

</div>
       正是所需的假设。

<div class="paragraph"> </div>


</li>
<li> 另一方面，假设 <span class="inlinecode"><span class="id" type="var">fold_constants_aexp</span></span> <span class="inlinecode"><span class="id" type="var">a1</span></span> 和 <span class="inlinecode"><span class="id" type="var">fold_constants_aexp</span></span> <span class="inlinecode"><span class="id" type="var">a2</span></span>
       之中有一个不是常量。这种情况我们需要证明

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">BEq</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a2</span>)),
<div class="paragraph"> </div>

</div>
       根据 <span class="inlinecode"><span class="id" type="var">beval</span></span> 的定义，它等同于证明

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a1</span>)&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;=&nbsp;<span class="id" type="var">beq_nat</span>&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a1</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a2</span>)).
<div class="paragraph"> </div>

</div>
       但是，由于算数表达式的健全性（定理 <span class="inlinecode"><span class="id" type="var">fold_constants_aexp_sound</span></span>），可得出

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a1</span>)<br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;<span class="id" type="var">a2</span>&nbsp;=&nbsp;<span class="id" type="var">aeval</span>&nbsp;<span class="id" type="var">st</span>&nbsp;(<span class="id" type="var">fold_constants_aexp</span>&nbsp;<span class="id" type="var">a2</span>),
<div class="paragraph"> </div>

</div>
       本例证毕。 <font size=-2>&#9744;</font>

</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">fold_constants_bexp_sound</span>: <br/>
&nbsp;&nbsp;<span class="id" type="var">btrans_sound</span> <span class="id" type="var">fold_constants_bexp</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">btrans_sound</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">b</span>. <span class="id" type="tactic">unfold</span> <span class="id" type="var">bequiv</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">st</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">b</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;BTrue&nbsp;和&nbsp;BFalse&nbsp;是显然的&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;BEq&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;当存在许多构造子时使用归纳法会使得认为指定变量名成为<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一件琐事，然而Coq并不总是能够选择足够漂亮的变量名。<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们可以使用&nbsp;重命名（<span class="inlinecode"><span class="id" type="tactic">rename</span></span>）策略:&nbsp;<span class="inlinecode"><span class="id" type="tactic">rename</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> <span class="inlinecode"><span class="id" type="var">into</span></span> <span class="inlinecode"><span class="id" type="var">a1</span></span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;会把当前目标和上下文中的&nbsp;<span class="inlinecode"><span class="id" type="var">a</span></span>&nbsp;替换成&nbsp;<span class="inlinecode"><span class="id" type="var">a1</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rename</span> <span class="id" type="var">a</span> <span class="id" type="var">into</span> <span class="id" type="var">a1</span>. <span class="id" type="tactic">rename</span> <span class="id" type="var">a0</span> <span class="id" type="var">into</span> <span class="id" type="var">a2</span>. <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a1</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">a1'</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqa1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">fold_constants_aexp</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">a2'</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqa2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1'</span>) <span class="id" type="tactic">by</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">subst</span> <span class="id" type="var">a1'</span>; <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">fold_constants_aexp_sound</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">replace</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>) <span class="id" type="keyword">with</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2'</span>) <span class="id" type="tactic">by</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="tactic">subst</span> <span class="id" type="var">a2'</span>; <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">fold_constants_aexp_sound</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">a1'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">a2'</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;唯一有趣的情况是&nbsp;a1&nbsp;和&nbsp;a2&nbsp;在折叠后同时变为常量&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">destruct</span> (<span class="id" type="var">beq_nat</span> <span class="id" type="var">n</span> <span class="id" type="var">n0</span>); <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;BLe&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">admit</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;BNot&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="var">remember</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">b'</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqb'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">b'</span>; <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;BAnd&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b1</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">b1'</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqb1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b2</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">b2'</span> <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqb2'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHb1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHb2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">b1'</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">b2'</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab484"></a><h4 class="section">Exercise: 3 stars (fold_constants_com_sound)</h4>
 补充以下证明的有关 <span class="inlinecode"><span class="id" type="var">WHILE</span></span> 的部分. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">fold_constants_com_sound</span> : <br/>
&nbsp;&nbsp;<span class="id" type="var">ctrans_sound</span> <span class="id" type="var">fold_constants_com</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">ctrans_sound</span>. <span class="id" type="tactic">intros</span> <span class="id" type="var">c</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">c</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;SKIP&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">refl_cequiv</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;::=&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">CAss_congruence</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">fold_constants_aexp_sound</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;;;&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">CSeq_congruence</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;IFB&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">bequiv</span> <span class="id" type="var">b</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="comment">(*&nbsp;断言的证明&nbsp;*)</span> <span class="id" type="tactic">apply</span> <span class="id" type="var">fold_constants_bexp_sound</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">fold_constants_bexp</span> <span class="id" type="var">b</span>) <span class="id" type="var">eqn</span>:<span class="id" type="var">Heqb</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;如果if没有被优化掉,&nbsp;那么我们很容易使用&nbsp;IH&nbsp;和&nbsp;fold_constants_bexp_sound&nbsp;来得出证明*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">apply</span> <span class="id" type="var">CIf_congruence</span>; <span class="id" type="tactic">assumption</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;b&nbsp;总为真&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_cequiv</span> <span class="id" type="keyword">with</span> <span class="id" type="var">c1</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IFB_true</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;b&nbsp;总为假&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">trans_cequiv</span> <span class="id" type="keyword">with</span> <span class="id" type="var">c2</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IFB_false</span>; <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;WHILE&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab485"></a><h3 class="section">(0 + n) 优化的健全性, 最终版</h3>

<div class="paragraph"> </div>

<a name="lab486"></a><h4 class="section">Exercise: 4 stars, advanced, optional (optimize_0plus)</h4>
 回顾 Imp.v 中 <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> 的定义:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span>&nbsp;<span class="id" type="var">optimize_0plus</span>&nbsp;(<span class="id" type="var">e</span>:<span class="id" type="var">aexp</span>)&nbsp;:&nbsp;<span class="id" type="var">aexp</span>&nbsp;:=&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span>&nbsp;<span class="id" type="var">e</span>&nbsp;<span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">ANum</span>&nbsp;<span class="id" type="var">n</span>&nbsp;⇒&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ANum</span>&nbsp;<span class="id" type="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">ANum</span>&nbsp;0)&nbsp;<span class="id" type="var">e2</span>&nbsp;⇒&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">APlus</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>&nbsp;⇒&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e1</span>)&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">AMinus</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>&nbsp;⇒&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">AMinus</span>&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e1</span>)&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">AMult</span>&nbsp;<span class="id" type="var">e1</span>&nbsp;<span class="id" type="var">e2</span>&nbsp;⇒&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">AMult</span>&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e1</span>)&nbsp;(<span class="id" type="var">optimize_0plus</span>&nbsp;<span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.
<div class="paragraph"> </div>

</div>
   注意这个函数是针对没有状态的旧 <span class="inlinecode"><span class="id" type="var">aexp</span></span> 写的.

<div class="paragraph"> </div>

   给 <span class="inlinecode"><span class="id" type="var">aexp</span></span> <span class="inlinecode"><span class="id" type="var">bexp</span></span> 和 <span class="inlinecode"><span class="id" type="var">com</span></span> 都写一个带状态的新版本:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">optimize_0plus_aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">optimize_0plus_bexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">optimize_0plus_com</span>
<div class="paragraph"> </div>

</div>
   明这三个函数都具有健全性，就像之前证明 <span class="inlinecode"><span class="id" type="var">fold_constants_</span>×</span> 那样。
   （在 <span class="inlinecode"><span class="id" type="var">optimize_0plus_com</span></span> 的证明中你需要一致性引理 &mdash; 否则证明过程会 <i>很长</i> ！）

<div class="paragraph"> </div>

   然后再在命令上定义一个新优化器，它首先使用常量折叠 （ <span class="inlinecode"><span class="id" type="var">fold_constants_com</span></span> ）
   然后使用 <span class="inlinecode">0</span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">n</span></span> 优化（ <span class="inlinecode"><span class="id" type="var">optimize_0plus_com</span></span> ）。

<div class="paragraph"> </div>

<ul class="doclist">
<li> 给这个优化器写出一个有意义的测试用例。

<div class="paragraph"> </div>


</li>
<li> 证明这个优化程序有健全性。（这部分应该会 <i>很简单</i> 。） 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab487"></a><h1 class="section">证明程序不等价</h1>

<div class="paragraph"> </div>

 假设 <span class="inlinecode"><span class="id" type="var">c1</span></span> 是形如 <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">a1</span>;;</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">a2</span></span> 的命令, 并且 <span class="inlinecode"><span class="id" type="var">c2</span></span> 是
    形如 <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">a1</span>;;</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode">::=</span> <span class="inlinecode"><span class="id" type="var">a2'</span></span> 的命令, <span class="inlinecode"><span class="id" type="var">a2'</span></span> 是把 <span class="inlinecode"><span class="id" type="var">a2</span></span> 中
    所有 <span class="inlinecode"><span class="id" type="var">X</span></span> 都替换为 <span class="inlinecode"><span class="id" type="var">a1</span></span> 后的结果.
    比如, <span class="inlinecode"><span class="id" type="var">c1</span></span> 和 <span class="inlinecode"><span class="id" type="var">c2</span></span> 可以像这样:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>&nbsp;&nbsp;=&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;42&nbsp;+&nbsp;53;;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;<span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span>&nbsp;&nbsp;=&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;42&nbsp;+&nbsp;53;;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;+&nbsp;(42&nbsp;+&nbsp;53))
<div class="paragraph"> </div>

</div>
    很明显在 <i>这个特定例子中</i> <span class="inlinecode"><span class="id" type="var">c1</span></span> 和 <span class="inlinecode"><span class="id" type="var">c2</span></span> 是等价的. 但是对一般程序而言这个结果成立吗? 
<div class="paragraph"> </div>

 我们马上就能看到这是不行的, 但是且慢, 现在, 看你自己能否找一个反例出来. 
<div class="paragraph"> </div>

 下面形式化的定义描述了在算数表达式里如何把某个变量的所有引用替换为另一个表达式: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">subst_aexp</span> (<span class="id" type="var">i</span> : <span class="id" type="var">id</span>) (<span class="id" type="var">u</span> : <span class="id" type="var">aexp</span>) (<span class="id" type="var">a</span> : <span class="id" type="var">aexp</span>) : <span class="id" type="var">aexp</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">a</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span>       ⇒ <span class="id" type="var">ANum</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AId</span> <span class="id" type="var">i'</span>       ⇒ <span class="id" type="keyword">if</span> <span class="id" type="var">eq_id_dec</span> <span class="id" type="var">i</span> <span class="id" type="var">i'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">u</span> <span class="id" type="keyword">else</span> <span class="id" type="var">AId</span> <span class="id" type="var">i'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  ⇒ <span class="id" type="var">APlus</span> (<span class="id" type="var">subst_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">subst_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> ⇒ <span class="id" type="var">AMinus</span> (<span class="id" type="var">subst_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">subst_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  ⇒ <span class="id" type="var">AMult</span> (<span class="id" type="var">subst_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">subst_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">u</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">subst_aexp_ex</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">subst_aexp</span> <span class="id" type="var">X</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 42) (<span class="id" type="var">ANum</span> 53)) (<span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>)) =<br/>
&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 42) (<span class="id" type="var">ANum</span> 53))).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
而这里是一个我们感兴趣的性质：它说明了类似上述形式的 <span class="inlinecode"><span class="id" type="var">c1</span></span> 和 <span class="inlinecode"><span class="id" type="var">c2</span></span> 总是等价.  
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">subst_equiv_property</span> := <span style="font-family: arial;">&forall;</span><span class="id" type="var">i1</span> <span class="id" type="var">i2</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> (<span class="id" type="var">i1</span> ::= <span class="id" type="var">a1</span>;; <span class="id" type="var">i2</span> ::= <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">i1</span> ::= <span class="id" type="var">a1</span>;; <span class="id" type="var">i2</span> ::= <span class="id" type="var">subst_aexp</span> <span class="id" type="var">i1</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab488"></a><h3 class="section"> </h3>
 遗憾的是, 这个性质 <i>不</i> 总是成立. 

<div class="paragraph"> </div>

    <i>Theorem</i>: 对于所有 <span class="inlinecode"><span class="id" type="var">i1</span></span>, <span class="inlinecode"><span class="id" type="var">i2</span></span>, <span class="inlinecode"><span class="id" type="var">a1</span></span>, 和 <span class="inlinecode"><span class="id" type="var">a2</span></span> 以下命题并不总是成立,

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span>&nbsp;(<span class="id" type="var">i1</span>&nbsp;::=&nbsp;<span class="id" type="var">a1</span>;;&nbsp;<span class="id" type="var">i2</span>&nbsp;::=&nbsp;<span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">i1</span>&nbsp;::=&nbsp;<span class="id" type="var">a1</span>;;&nbsp;<span class="id" type="var">i2</span>&nbsp;::=&nbsp;<span class="id" type="var">subst_aexp</span>&nbsp;<span class="id" type="var">i1</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>).
<div class="paragraph"> </div>

</div>
    <i>Proof</i>: 我们使用反证法，假设对于所有 <span class="inlinecode"><span class="id" type="var">i1</span></span>, <span class="inlinecode"><span class="id" type="var">i2</span></span>, <span class="inlinecode"><span class="id" type="var">a1</span></span>, 和 <span class="inlinecode"><span class="id" type="var">a2</span></span>, 下面的假设成立

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span>&nbsp;(<span class="id" type="var">i1</span>&nbsp;::=&nbsp;<span class="id" type="var">a1</span>;;&nbsp;<span class="id" type="var">i2</span>&nbsp;::=&nbsp;<span class="id" type="var">a2</span>)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">i1</span>&nbsp;::=&nbsp;<span class="id" type="var">a1</span>;;&nbsp;<span class="id" type="var">i2</span>&nbsp;::=&nbsp;<span class="id" type="var">subst_aexp</span>&nbsp;<span class="id" type="var">i1</span>&nbsp;<span class="id" type="var">a1</span>&nbsp;<span class="id" type="var">a2</span>).
<div class="paragraph"> </div>

</div>
    那么考虑下面的程序:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1);;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>
<div class="paragraph"> </div>

</div>
    注意下面的假设

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1);;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;<span class="id" type="var">empty_state</span>&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;<span class="id" type="var">st1</span>,
<div class="paragraph"> </div>

</div>
    在 <span class="inlinecode"><span class="id" type="var">st1</span></span> <span class="inlinecode">=</span> <span class="inlinecode">{</span> <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8614;</span></span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8614;</span></span> <span class="inlinecode">1</span> <span class="inlinecode">}</span> 时成立.

<div class="paragraph"> </div>

    根据假设

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">cequiv</span>&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1);;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1);;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1))
<div class="paragraph"> </div>

</div>
    同时根据 <span class="inlinecode"><span class="id" type="var">cequiv</span></span> 的定义, 我们有

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1);;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;<span class="id" type="var">empty_state</span>&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;<span class="id" type="var">st1</span>.
<div class="paragraph"> </div>

</div>
    同时我们也能证明出

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1);;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">APlus</span>&nbsp;(<span class="id" type="var">AId</span>&nbsp;<span class="id" type="var">X</span>)&nbsp;(<span class="id" type="var">ANum</span>&nbsp;1))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;<span class="id" type="var">empty_state</span>&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;<span class="id" type="var">st2</span>,
<div class="paragraph"> </div>

</div>
    在 <span class="inlinecode"><span class="id" type="var">st2</span></span> <span class="inlinecode">=</span> <span class="inlinecode">{</span> <span class="inlinecode"><span class="id" type="var">X</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8614;</span></span> <span class="inlinecode">1,</span> <span class="inlinecode"><span class="id" type="var">Y</span></span> <span class="inlinecode"><span style="font-family: arial;">&#8614;</span></span> <span class="inlinecode">2</span> <span class="inlinecode">}</span> 时成立。这里注意, 因为 <span class="inlinecode"><span class="id" type="var">ceval</span></span> 是确定性的
    但是已知 <span class="inlinecode"><span class="id" type="var">st1</span></span> <span class="inlinecode">≠</span> <span class="inlinecode"><span class="id" type="var">st2</span></span> 这就造成矛盾!  <font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">subst_inequiv</span> : <br/>
&nbsp;&nbsp;¬ <span class="id" type="var">subst_equiv_property</span>.<br/>
<div class="togglescript" id="proofcontrol18" onclick="toggleDisplay('proof18');toggleDisplay('proofcontrol18')"><span class="show"></span></div>
<div class="proofscript" id="proof18" onclick="toggleDisplay('proof18');toggleDisplay('proofcontrol18')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">subst_equiv_property</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">Contra</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;这里有个反例:&nbsp;假设&nbsp;<span class="inlinecode"><span class="id" type="var">subst_equiv_property</span></span>&nbsp;让我们证明以下两个程序等价...&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1);; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AId</span> <span class="id" type="var">X</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">as</span> <span class="id" type="var">c1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1);; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">as</span> <span class="id" type="var">c2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) <span class="id" type="tactic">by</span> (<span class="id" type="tactic">subst</span>; <span class="id" type="tactic">apply</span> <span class="id" type="var">Contra</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;...&nbsp;让我们证明&nbsp;<span class="inlinecode"><span class="id" type="var">c2</span></span>&nbsp;能终止于两个不同的状态:&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st1&nbsp;=&nbsp;{X&nbsp;|-&gt;&nbsp;1,&nbsp;Y&nbsp;|-&gt;&nbsp;1}&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st2&nbsp;=&nbsp;{X&nbsp;|-&gt;&nbsp;1,&nbsp;Y&nbsp;|-&gt;&nbsp;2}.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 1) <span class="id" type="var">Y</span> 1) <span class="id" type="keyword">as</span> <span class="id" type="var">st1</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">remember</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 1) <span class="id" type="var">Y</span> 2) <span class="id" type="keyword">as</span> <span class="id" type="var">st2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H1</span>: <span class="id" type="var">c1</span> / <span class="id" type="var">empty_state</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st1</span>);<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">H2</span>: <span class="id" type="var">c2</span> / <span class="id" type="var">empty_state</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st2</span>);<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Seq</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">st'</span> := (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 1)); <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Ass</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">H</span> <span class="id" type="keyword">in</span> <span class="id" type="var">H1</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;最后,&nbsp;因为程序求值的确定性而产生矛盾.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hcontra</span>: <span class="id" type="var">st1</span> = <span class="id" type="var">st2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">by</span> (<span class="id" type="tactic">apply</span> (<span class="id" type="var">ceval_deterministic</span> <span class="id" type="var">c2</span> <span class="id" type="var">empty_state</span>); <span class="id" type="tactic">assumption</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">Hcontra'</span>: <span class="id" type="var">st1</span> <span class="id" type="var">Y</span> = <span class="id" type="var">st2</span> <span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">by</span> (<span class="id" type="tactic">rewrite</span> <span class="id" type="var">Hcontra</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;<span class="id" type="tactic">subst</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">Hcontra'</span>. <span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
</div>

<div class="doc">
<a name="lab489"></a><h4 class="section">Exercise: 4 stars, optional (better_subst_equiv)</h4>
 之前我们想的等价性也不是完全胡说八道 &mdash; 差一点就正确了. 只要增加一个
    条件就是正确的, 只要保证 <span class="inlinecode"><span class="id" type="var">X</span></span> 不在第一个等式的右边出现. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">var_not_used_in_aexp</span> (<span class="id" type="var">X</span>:<span class="id" type="var">id</span>) : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">VNUNum</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">n</span>, <span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> (<span class="id" type="var">ANum</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">VNUId</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">Y</span>, <span class="id" type="var">X</span> ≠ <span class="id" type="var">Y</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">VNUPlus</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">a1</span> <span class="id" type="var">a2</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> <span class="id" type="var">a1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> <span class="id" type="var">a2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> (<span class="id" type="var">APlus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">VNUMinus</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">a1</span> <span class="id" type="var">a2</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> <span class="id" type="var">a1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> <span class="id" type="var">a2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> (<span class="id" type="var">AMinus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">VNUMult</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">a1</span> <span class="id" type="var">a2</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> <span class="id" type="var">a1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> <span class="id" type="var">a2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">X</span> (<span class="id" type="var">AMult</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>).<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">aeval_weakening</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">i</span> <span class="id" type="var">st</span> <span class="id" type="var">a</span> <span class="id" type="var">ni</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">i</span> <span class="id" type="var">a</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">i</span> <span class="id" type="var">ni</span>) <span class="id" type="var">a</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
使用 <span class="inlinecode"><span class="id" type="var">var_not_used_in_aexp</span></span> 形式化证明这个正确版的 <span class="inlinecode"><span class="id" type="var">subst_equiv_property</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab490"></a><h4 class="section">Exercise: 3 stars, optional (inequiv_exercise)</h4>
 证明死循环不等价于 <span class="inlinecode"><span class="id" type="var">SKIP</span></span> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">inequiv_exercise</span>: <br/>
&nbsp;&nbsp;¬ <span class="id" type="var">cequiv</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span class="id" type="var">DO</span> <span class="id" type="var">SKIP</span> <span class="id" type="var">END</span>) <span class="id" type="var">SKIP</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab491"></a><h1 class="section">扩展练习: 非确定性 Imp</h1>

<div class="paragraph"> </div>

 就像之前看到的 (在 Imp那章里的 <span class="inlinecode"><span class="id" type="var">ceval_deterministic</span></span>), Imp 的关联的求值
    是确定性的.  但是, <i>不确定性</i> 是很多程序语言定义中重要的一部分. 比如, 在很多
    命令式语言中 (比如C和类C的语言), 函数参数的求值顺序是未定义的. 程序片段

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">x</span>&nbsp;=&nbsp;0;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">f</span>(++<span class="id" type="var">x</span>,&nbsp;<span class="id" type="var">x</span>)
<div class="paragraph"> </div>

</div>
    调用 <span class="inlinecode"><span class="id" type="var">f</span></span> 的参数也许是 <span class="inlinecode">(1,</span> <span class="inlinecode">0)</span> 又也许是 <span class="inlinecode">(1,</span> <span class="inlinecode">1)</span>, 取决于编译器的选择. 
    这可能让程序员有些困惑, 但是给了编译器作者选择实现的自由.

<div class="paragraph"> </div>

    在这个练习里, 我们要用一个简单的非确定性命令扩展 Imp 来学习这个扩展对响程
    序等价性有什么影响.  这个新命令写作 <span class="inlinecode"><span class="id" type="var">HAVOC</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span>, <span class="inlinecode"><span class="id" type="var">X</span></span> 是一个标识符.
    执行 <span class="inlinecode"><span class="id" type="var">HAVOC</span></span> <span class="inlinecode"><span class="id" type="var">X</span></span> 的作用是给 <span class="inlinecode"><span class="id" type="var">X</span></span> 分配一个不确定的 <i>任意</i> 数字. 比如,
    计算这个程序之后:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HAVOC</span>&nbsp;<span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;×&nbsp;2
<div class="paragraph"> </div>

</div>
    <span class="inlinecode"><span class="id" type="var">Y</span></span> 的值可以是任意变量, 且 <span class="inlinecode"><span class="id" type="var">Z</span></span> 的值是 <span class="inlinecode"><span class="id" type="var">Y</span></span> 的两倍 (所以 <span class="inlinecode"><span class="id" type="var">Z</span></span> 总是偶数).
    注意, 我们并没有讨论输出值的 <i>概率</i> &mdash; 只是这里在执行非确定性代码后有
    非常多（无穷）的可能的不同的输出.

<div class="paragraph"> </div>

    某种意义上来说 <span class="inlinecode"><span class="id" type="var">HAVOC</span></span> 大致相当与C语言中的未初始化变量. 经过了 <span class="inlinecode"><span class="id" type="var">HAVOC</span></span>
    变量获得一个任意的但是不会改变的数字.  语言定义中非确定性大部分来源于程序员
    对程序到底作出了什么选择并不那么关心 (好处是能让编译器有自由选择运行速度更快的方法).

<div class="paragraph"> </div>

    我们称这个新语言为 <i>Himp</i> (``在 Imp 上扩展了 <span class="inlinecode"><span class="id" type="var">HAVOC</span></span>''). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">Himp</span>.<br/>

<br/>
</div>

<div class="doc">
为了形式化这个语言, 我们先在命令定义里增加一条. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">com</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">CSkip</span> : <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CAss</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CSeq</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CIf</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CWhile</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CHavoc</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span>. <span class="comment">(*&nbsp;&lt;----&nbsp;新的&nbsp;*)</span><br/>

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" :=<br/>
&nbsp;&nbsp;<span class="id" type="var">CSkip</span>.<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CAss</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "c1 ;; c2" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CSeq</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" :=<br/>
&nbsp;&nbsp;(<span class="id" type="var">CIf</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'HAVOC' l" := (<span class="id" type="var">CHavoc</span> <span class="id" type="var">l</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>

<br/>
</div>

<div class="doc">
<a name="lab492"></a><h4 class="section">Exercise: 2 stars (himp_ceval)</h4>
 现在, 我们必须扩展操作语义. 这里提供了一个 <span class="inlinecode"><span class="id" type="var">ceval</span></span> 关系的模板, 规定了
    其大步语义. 现在为了形式化 <span class="inlinecode"><span class="id" type="var">HAVOC</span></span> 规则还需要怎样的扩充？ 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Skip</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> : <span class="id" type="var">state</span>, <span class="id" type="var">SKIP</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Ass</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">a1</span> : <span class="id" type="var">aexp</span>) (<span class="id" type="var">n</span> : <span class="id" type="var">nat</span>) (<span class="id" type="var">X</span> : <span class="id" type="var">id</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">a1</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Seq</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>) (<span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">c2</span> / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">c1</span> ;; <span class="id" type="var">c2</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfTrue</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfFalse</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileEnd</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">c1</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileLoop</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">b1</span> : <span class="id" type="var">bexp</span>) (<span class="id" type="var">c1</span> : <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<span class="id" type="var">ceval</span> <span class="id" type="var">c1</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>

<br/>
</div>

<div class="doc">
作为合理的检查, 下面的命题使用你的定义应该是可证的: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">havoc_example1</span> : (<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>) / <span class="id" type="var">empty_state</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 0.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">havoc_example2</span> :<br/>
&nbsp;&nbsp;(<span class="id" type="var">SKIP</span>;; <span class="id" type="var">HAVOC</span> <span class="id" type="var">Z</span>) / <span class="id" type="var">empty_state</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">Z</span> 42.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 最后, 我们重新定义和之前相同的等价性定理: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">cequiv</span> (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>) : <span class="id" type="keyword">Prop</span> := <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&harr;</span> <span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>.<br/>

<br/>
</div>

<div class="doc">
这个定义对于可终止的程序仍然是合理的, 然后我们来用它证明非确定性程序的等价
    或者非等价. 
<div class="paragraph"> </div>

<a name="lab493"></a><h4 class="section">Exercise: 3 stars (havoc_swap)</h4>
 下面的两个程序等价吗? 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pXY</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>;; <span class="id" type="var">HAVOC</span> <span class="id" type="var">Y</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pYX</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">Y</span>;; <span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>.<br/>

<br/>
</div>

<div class="doc">
如果你认为他是等价的, 证明它是等价的, 如果认为它是不等价的, 也给出证明. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pXY_cequiv_pYX</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">pXY</span> <span class="id" type="var">pYX</span> <span style="font-family: arial;">&or;</span> ¬<span class="id" type="var">cequiv</span> <span class="id" type="var">pXY</span> <span class="id" type="var">pYX</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab494"></a><h4 class="section">Exercise: 4 stars, optional (havoc_copy)</h4>
 下面的两个程序等价吗? 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">ptwice</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>;; <span class="id" type="var">HAVOC</span> <span class="id" type="var">Y</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pcopy</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>;; <span class="id" type="var">Y</span> ::= <span class="id" type="var">AId</span> <span class="id" type="var">X</span>.<br/>

<br/>
</div>

<div class="doc">
如果你认为他是等价的, 证明它是等价的, 如果认为它是不等价的, 也给出证明.
    (Hint: 你也许会发现 <span class="inlinecode"><span class="id" type="tactic">assert</span></span> 策略很有用.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ptwice_cequiv_pcopy</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">ptwice</span> <span class="id" type="var">pcopy</span> <span style="font-family: arial;">&or;</span> ¬<span class="id" type="var">cequiv</span> <span class="id" type="var">ptwice</span> <span class="id" type="var">pcopy</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 我们使用的程序等价的定义在无限循环的程序上的结果有点复杂. 因为 <span class="inlinecode"><span class="id" type="var">cequiv</span></span> 
    描述的是 <i>程序能够终止时</i> 两个程序的输出等价. 但是, 在有类似 Himp 的
    非确定性的语言里，有些程序总是停机，有些程序总是死循环，还有一些程序会
    非确定性地在某些时候停机或者在另外一些时候不断循环。下面习题的最后一部分展示了这个现象.

<div class="paragraph"> </div>

<a name="lab495"></a><h4 class="section">Exercise: 5 stars, advanced (p1_p2_equiv)</h4>
 证明 p1 和 p2 等价. 在下面的联系中, 尝试理解为什么 <span class="inlinecode"><span class="id" type="var">cequiv</span></span> 的定义会
    导致它对这些例子产生的行为。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">p1</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">Y</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">APlus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">p2</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
直觉上, 这两个程序有相同的终止行为: 要么都死循环, 要么终止在同一个状态.
    我们用下面的引理可以分别捕获 p1 和 p2 的终止行为: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">p1_may_diverge</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span>, <span class="id" type="var">st</span> <span class="id" type="var">X</span> ≠ 0 <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;¬ <span class="id" type="var">p1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">p2_may_diverge</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span>, <span class="id" type="var">st</span> <span class="id" type="var">X</span> ≠ 0 <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;¬ <span class="id" type="var">p2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>

<br/>
</div>

<div class="doc">
你应该用这些引理证明 p1 和 p2 确实等价. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">p1_p2_equiv</span> : <span class="id" type="var">cequiv</span> <span class="id" type="var">p1</span> <span class="id" type="var">p2</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab496"></a><h4 class="section">Exercise: 4 stars, advanced (p3_p4_inquiv)</h4>

<div class="paragraph"> </div>

 证明下面的程序 <i>不等价</i> . 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">p3</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">ANum</span> 1;;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 0))) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">Z</span><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">p4</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">X</span> ::= (<span class="id" type="var">ANum</span> 0);;<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= (<span class="id" type="var">ANum</span> 1).<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">p3_p4_inequiv</span> : ¬ <span class="id" type="var">cequiv</span> <span class="id" type="var">p3</span> <span class="id" type="var">p4</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab497"></a><h4 class="section">Exercise: 5 stars, advanced, optional (p5_p6_equiv)</h4>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">p5</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 1))) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">HAVOC</span> <span class="id" type="var">X</span><br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">p6</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> 1.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">p5_p6_equiv</span> : <span class="id" type="var">cequiv</span> <span class="id" type="var">p5</span> <span class="id" type="var">p6</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">End</span> <span class="id" type="var">Himp</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab498"></a><h1 class="section">不使用外延公理 (进阶)</h1>

<div class="paragraph"> </div>

 纯粹主义者可能会反对使用 外延公理（ <span class="inlinecode"><span class="id" type="var">functional_extensionality</span></span> ）。
    总的来说, 增加新公理是很危险的, 特别是一次增加多个的时候（它们可能会互相不一致）。
    事实上， <span class="inlinecode"><span class="id" type="var">functional_extensionality</span></span> 和 <span class="inlinecode"><span class="id" type="var">excluded_middle</span></span> 的加入
    都不会造成任何问题，但是一些 Coq 使用者更愿意避开这些“重量级”的通用技巧，
    而对特定问题在Coq的标准逻辑之内构造解决方案。

<div class="paragraph"> </div>

    与其为了对表示状态的函数进行我们想进行的任意操作而扩展等价的定义，
    不如为了表示状态的 <i>等价性</i> 而专门给出一个明晰的定义。例如： 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">stequiv</span> (<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> : <span class="id" type="var">state</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">X</span>:<span class="id" type="var">id</span>), <span class="id" type="var">st1</span> <span class="id" type="var">X</span> = <span class="id" type="var">st2</span> <span class="id" type="var">X</span>.<br/>

<br/>
<span class="id" type="keyword">Notation</span> "st1 '¬' st2" := (<span class="id" type="var">stequiv</span> <span class="id" type="var">st1</span> <span class="id" type="var">st2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 30).<br/>

<br/>
</div>

<div class="doc">
证明 <span class="inlinecode"><span class="id" type="var">stequiv</span></span> 的 <i>等价性</i> （ <i>equivalence</i> ）很简单 （即，它包含自反性，对称性和
    传递性），所以它能把所有状态中等价的状态分离出来。 
<div class="paragraph"> </div>

<a name="lab499"></a><h4 class="section">Exercise: 1 star, optional (stequiv_refl)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_refl</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> : <span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">st</span> ¬ <span class="id" type="var">st</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab500"></a><h4 class="section">Exercise: 1 star, optional (stequiv_sym)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_sym</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> : <span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span class="id" type="var">st2</span> ¬ <span class="id" type="var">st1</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab501"></a><h4 class="section">Exercise: 1 star, optional (stequiv_trans)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_trans</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> <span class="id" type="var">st3</span> : <span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span class="id" type="var">st2</span> ¬ <span class="id" type="var">st3</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st3</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 Another useful fact... <a name="lab502"></a><h4 class="section">Exercise: 1 star, optional (stequiv_update)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_update</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">X</span>:<span class="id" type="var">id</span>) (<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">update</span> <span class="id" type="var">st1</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span> ¬ <span class="id" type="var">update</span> <span class="id" type="var">st2</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 显然 <span class="inlinecode"><span class="id" type="var">aeval</span></span> 和 <span class="inlinecode"><span class="id" type="var">beval</span></span> 对所有等价的情况行为一致： 
<div class="paragraph"> </div>

<a name="lab503"></a><h4 class="section">Exercise: 2 stars, optional (stequiv_aeval)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_aeval</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> : <span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">a</span>:<span class="id" type="var">aexp</span>), <span class="id" type="var">aeval</span> <span class="id" type="var">st1</span> <span class="id" type="var">a</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">st2</span> <span class="id" type="var">a</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab504"></a><h4 class="section">Exercise: 2 stars, optional (stequiv_beval)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_beval</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> : <span class="id" type="var">state</span>), <br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">b</span>:<span class="id" type="var">bexp</span>), <span class="id" type="var">beval</span> <span class="id" type="var">st1</span> <span class="id" type="var">b</span> = <span class="id" type="var">beval</span> <span class="id" type="var">st2</span> <span class="id" type="var">b</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 我们同样能描述 <span class="inlinecode"><span class="id" type="var">ceval</span></span> 在等价状态下的行为 (因为<span class="inlinecode"><span class="id" type="var">ceval</span></span>是一个关系，
    所以这里有一点复杂)。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">stequiv_ceval</span>: <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st1</span> <span class="id" type="var">st2</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">st1</span> ¬ <span class="id" type="var">st2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c</span>: <span class="id" type="var">com</span>) (<span class="id" type="var">st1'</span>: <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c</span> / <span class="id" type="var">st1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st1'</span>) <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2'</span> : <span class="id" type="var">state</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" type="var">c</span> / <span class="id" type="var">st2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st2'</span>) <span style="font-family: arial;">&and;</span>  <span class="id" type="var">st1'</span> ¬ <span class="id" type="var">st2'</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">st1</span> <span class="id" type="var">st2</span> <span class="id" type="var">STEQV</span> <span class="id" type="var">c</span> <span class="id" type="var">st1'</span> <span class="id" type="var">CEV1</span>. <span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">st2</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">CEV1</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">st2</span> <span class="id" type="var">STEQV</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;SKIP&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;:=&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span>(<span class="id" type="var">update</span> <span class="id" type="var">st2</span> <span class="id" type="var">x</span> <span class="id" type="var">n</span>). <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_aeval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_update</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHCEV1_1</span> <span class="id" type="var">st2</span> <span class="id" type="var">STEQV</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">st2'</span> [<span class="id" type="var">P1</span> <span class="id" type="var">EQV1</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHCEV1_2</span> <span class="id" type="var">st2'</span> <span class="id" type="var">EQV1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">st2''</span> [<span class="id" type="var">P2</span> <span class="id" type="var">EQV2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2''</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_Seq</span> <span class="id" type="keyword">with</span> <span class="id" type="var">st2'</span>;  <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;IfTrue&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHCEV1</span> <span class="id" type="var">st2</span> <span class="id" type="var">STEQV</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">st2'</span> [<span class="id" type="var">P</span> <span class="id" type="var">EQV</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2'</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfTrue</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_beval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;IfFalse&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHCEV1</span> <span class="id" type="var">st2</span> <span class="id" type="var">STEQV</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">st2'</span> [<span class="id" type="var">P</span> <span class="id" type="var">EQV</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2'</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_IfFalse</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_beval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;WhileEnd&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileEnd</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_beval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;WhileLoop&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHCEV1_1</span> <span class="id" type="var">st2</span> <span class="id" type="var">STEQV</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">st2'</span> [<span class="id" type="var">P1</span> <span class="id" type="var">EQV1</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">IHCEV1_2</span> <span class="id" type="var">st2'</span> <span class="id" type="var">EQV1</span>) <span class="id" type="keyword">as</span> [<span class="id" type="var">st2''</span> [<span class="id" type="var">P2</span> <span class="id" type="var">EQV2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family: arial;">&exist;</span><span class="id" type="var">st2''</span>. <span class="id" type="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_WhileLoop</span> <span class="id" type="keyword">with</span> <span class="id" type="var">st2'</span>. <span class="id" type="tactic">rewrite</span> <span style="font-family: arial;">&larr;</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">symmetry</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_beval</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
现在我们需要使用 <span class="inlinecode">¬</span> 而不是 <span class="inlinecode">=</span> 来重新定义 <span class="inlinecode"><span class="id" type="var">cequiv</span></span> 。 让定义保持简单
    而又对称不是那么简单，这里是其中一种比较好的方式 （感谢 Andrew McCreight）。
    我们先定义一个宽松版的 <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> 来“概括”等价性的记号。 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>'' st'" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval'</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_equiv</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">c</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st'</span> ¬ <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span>' <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span>   "c1 '/' st '<span style="font-family: arial;">&dArr;</span>'' st'" := (<span class="id" type="var">ceval'</span> <span class="id" type="var">c1</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>

<br/>
</div>

<div class="doc">
修订过的 <span class="inlinecode"><span class="id" type="var">cequiv'</span></span> 定义看上去比较眼熟： 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">cequiv'</span> (<span class="id" type="var">c1</span> <span class="id" type="var">c2</span> : <span class="id" type="var">com</span>) : <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span style="font-family: arial;">&forall;</span>(<span class="id" type="var">st</span> <span class="id" type="var">st'</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span>' <span class="id" type="var">st'</span>) <span style="font-family: arial;">&harr;</span> (<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span>' <span class="id" type="var">st'</span>).<br/>

<br/>
</div>

<div class="doc">
现在仔细检查原等价概念是不是至少和新的一样强。 （当然。逆命题是不成立的。） 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">cequiv__cequiv'</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">c1</span> <span class="id" type="var">c2</span>: <span class="id" type="var">com</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">cequiv'</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">cequiv</span>, <span class="id" type="var">cequiv'</span>; <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> ; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_equiv</span> <span class="id" type="keyword">with</span> <span class="id" type="var">st'0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">st</span> <span class="id" type="var">st'0</span>); <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span> ; <span class="id" type="tactic">subst</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">E_equiv</span> <span class="id" type="keyword">with</span> <span class="id" type="var">st'0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> (<span class="id" type="var">H</span> <span class="id" type="var">st</span> <span class="id" type="var">st'0</span>). <span class="id" type="tactic">assumption</span>. <span class="id" type="tactic">assumption</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab505"></a><h4 class="section">Exercise: 2 stars, optional (identity_assignment')</h4>
 最终，这里又是我们的例子... （现在你可以完成证明了。） 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">identity_assignment'</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv'</span> <span class="id" type="var">SKIP</span> (<span class="id" type="var">X</span> ::= <span class="id" type="var">AId</span> <span class="id" type="var">X</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">cequiv'</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">split</span>; <span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;-&gt;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">H</span>. <span class="id" type="tactic">inversion</span> <span class="id" type="var">H0</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_equiv</span> <span class="id" type="keyword">with</span> (<span class="id" type="var">update</span> <span class="id" type="var">st'0</span> <span class="id" type="var">X</span> (<span class="id" type="var">st'0</span> <span class="id" type="var">X</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">stequiv_trans</span> <span class="id" type="keyword">with</span> <span class="id" type="var">st'0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">unfold</span> <span class="id" type="var">stequiv</span>. <span class="id" type="tactic">intros</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">update_same</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="id" type="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;&lt;-&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 总的来说, 使用这种显性定义等价的方法相较起使用外延公理来会相当复杂。
    （Coq有一个称作‘等价类型’（"setoids"）的高级机制，它允许这些关系在Coq
    系统中登记并让标准的重写策略将这些关系与等式几乎看作是相同的，这样在进行
    与等价性相关的工作时会在某种程度上变得更加容易。）
    但是这是值得去做的, 因为它也能应用在函数 <i>之外</i> 的等价问题上。比如，
    如果我们使用二叉搜索树来实现状态映射，对这类问题我们就需要显性等价。 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab506"></a><h1 class="section">附加题</h1>

<div class="paragraph"> </div>

<a name="lab507"></a><h4 class="section">Exercise: 4 stars, optional (for_while_equiv)</h4>
 这个练习是 Imp.v 中 可选练习<span class="inlinecode"><span class="id" type="var">add_for_loop</span></span> 的扩展,
    就是那个让你扩展出类似C风格的for循环命令的练习.  证明命令:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">for</span>&nbsp;(<span class="id" type="var">c1</span>&nbsp;;&nbsp;<span class="id" type="var">b</span>&nbsp;;&nbsp;<span class="id" type="var">c2</span>)&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c3</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
<div class="paragraph"> </div>

</div>
    等价于:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span>&nbsp;;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">b</span>&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c3</span>&nbsp;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab508"></a><h4 class="section">Exercise: 3 stars, optional (swap_noninterfering_assignments)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">swap_noninterfering_assignments</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">l1</span> <span class="id" type="var">l2</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">l1</span> ≠ <span class="id" type="var">l2</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">l1</span> <span class="id" type="var">a2</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">var_not_used_in_aexp</span> <span class="id" type="var">l2</span> <span class="id" type="var">a1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">cequiv</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l1</span> ::= <span class="id" type="var">a1</span>;; <span class="id" type="var">l2</span> ::= <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">l2</span> ::= <span class="id" type="var">a2</span>;; <span class="id" type="var">l1</span> ::= <span class="id" type="var">a1</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
<span class="comment">(*&nbsp;提示:&nbsp;你应该会用到&nbsp;<span class="inlinecode"><span class="id" type="var">functional_extensionality</span></span>&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a></div>

</div>

</body>
</html>